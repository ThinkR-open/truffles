---
title: "flat_utils_db.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# connect_db
    
```{r function-connect_db}
#' connect_db
#' 
#' To connect to the database available in the {truffles} package
#' 
#' @param dbname name of db available in inst/
#' @importFrom RSQLite SQLite
#' @importFrom DBI dbConnect
#' @return NULL
#' 
#' @export
connect_db <- function(dbname = "chenes_truffe.sqlite"){
    conn <- dbConnect(SQLite(), 
                      system.file(dbname, package = "truffles"))
    return(conn)
}
```
  
```{r example-connect_db}
connect_db()
```
  
```{r tests-connect_db}
test_that("connect_db works", {
  conn <- connect_db()

  # Vérifier que la connexion est valide
  expect_s4_class(conn, "SQLiteConnection")
})
```

# write_db_new_truffe
    
```{r function-write_db_new_truffe}
#' write_db_new_truffe
#' 
#' Description
#'
#' @param conn a connection to database
#' @param id_chene TOCOMPLETE
#' @param date_trouvee TOCOMPLETE 
#' @param poids TOCOMPLETE
#'
#' @importFrom digest digest
#' @importFrom DBI dbAppendTable
#' @return NULL
#' 
#' @export
write_db_new_truffe <-
  function(conn = connect_db(), id_chene, date_trouvee, poids, comment, digest_ = Sys.time()) {
    
  idtruffe = digest(digest_)
    
  add_truffe <- data.frame(
  id_truffe = idtruffe,
  id_chene = id_chene,
  date_trouve = as.Date(date_trouvee),
  poids = poids,
  commentaires = comment
)
  
  dbAppendTable(conn, "truffe", add_truffe)
  }
```
  
```{r example-write_db_new_truffe}
# write_db_new_truffe(id_chene = "chene")
```
  
```{r tests-write_db_new_truffe}
test_that("write_db_new_truffe works", {
  conn <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")
  
  # Création de la table truffe dans la base de données
  DBI::dbWriteTable(
    conn,
    "truffe",
    data.frame(
      id_truffe = character(),
      id_chene = numeric(),
      date_trouve = numeric(),
      poids = numeric(),
      commentaires = character()
    )
  )
  
  # Écrire une nouvelle truffe dans la base de données
  id_chene <- 1
  date_trouvee <- "2024-03-08"
  poids <- 50
  comment <- "Truffe fraîchement trouvée"
  write_db_new_truffe(conn, id_chene, date_trouvee, poids, comment, digest_ = date_trouvee)
  
  # Vérifier si la truffe a été correctement ajoutée à la base de données
  expected_output <-
    data.frame(
      id_truffe = digest::digest(date_trouvee),
      id_chene = 1,
      date_trouve = 19790,
      poids = 50,
      commentaires = "Truffe fraîchement trouvée"
    )
  expect_equal(DBI::dbReadTable(conn, "truffe"), expected_output)
})
```
  

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_utils_db.Rmd", 
               vignette_name = NA, 
               check = FALSE)
```

